<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Flavourman Battle - A tasty fighting game!">
    <title>Flavortown Battle</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="bg-layer"></div>

    <div class="app-container">
        <div id="screens">

            <!-- LOGIN SCREEN -->
            <section id="login-screen" class="screen active">
                <div class="menu-container">
                    <div class="game-title">
                        <div class="title-main">FLAVORTOWN</div>
                        <div class="title-sub">BATTLE</div>
                    </div>
                    <div class="screen-subtitle">LOGIN / SIGN UP</div>

                    <div class="input-cartoon">
                        <span class="input-icon">üìß</span>
                        <input type="email" id="username" placeholder="EMAIL (e.g. you@gmail.com)">
                    </div>
                    <div class="input-cartoon">
                        <span class="input-icon">üîí</span>
                        <input type="password" id="password" placeholder="PASSWORD">
                    </div>

                    <div class="button-row">
                        <button class="btn-cartoon green btn-small" onclick="handleLogin()">
                            <span class="btn-icon">‚öîÔ∏è</span> LOGIN
                        </button>
                        <button class="btn-cartoon blue btn-small" onclick="handleSignup()">
                            <span class="btn-icon">‚öôÔ∏è</span> SIGN UP
                        </button>
                    </div>

                    <button class="btn-cartoon gray btn-small" style="width:100%;margin-top:10px"
                        onclick="handleGuest()">
                        üë§ PLAY AS GUEST
                    </button>

                    <div class="forgot-link" onclick="alert('Check your email!')">FORGOT PASSWORD?</div>
                </div>
            </section>

            <!-- MAIN MENU -->
            <section id="main-menu" class="screen">
                <div class="menu-container">
                    <div class="game-title">
                        <div class="title-main">FLAVORTOWN</div>
                        <div class="title-sub">BATTLE</div>
                    </div>

                    <div class="button-group">
                        <button class="btn-cartoon green" onclick="showScreen('mode-select')">
                            <span class="btn-icon">‚öîÔ∏è</span> PLAY
                        </button>
                        <button class="btn-cartoon blue" onclick="showScreen('settings')">
                            <span class="btn-icon">‚öôÔ∏è</span> OPTIONS
                        </button>
                        <button class="btn-cartoon red" onclick="showScreen('leaderboard')">
                            <span class="btn-icon">üèÜ</span> LEADERBOARD
                        </button>
                    </div>
                </div>
            </section>

            <!-- MODE SELECT -->
            <section id="mode-select" class="screen">
                <div class="menu-container">
                    <div class="game-title">
                        <div class="title-main">FLAVORTOWN</div>
                        <div class="title-sub">BATTLE</div>
                    </div>

                    <div class="button-group">
                        <button class="btn-cartoon blue" onclick="startCharSelect('local')">
                            <span class="btn-icon">üéÆ</span> LOCAL
                        </button>
                        <button class="btn-cartoon purple" onclick="startCharSelect('ai')">
                            <span class="btn-icon">ü§ñ</span> AI
                        </button>
                        <button class="btn-cartoon locked" onclick="showLockedMessage()">
                            <span class="btn-icon">üåê</span> MULTIPLAYER
                            <span class="lock-icon">üîí</span>
                        </button>
                    </div>

                    <button class="btn-cartoon gray btn-small" style="margin-top:20px"
                        onclick="showScreen('main-menu')">
                        ‚Üê BACK
                    </button>
                </div>
            </section>

            <!-- CHARACTER SELECT -->
            <section id="char-select" class="screen">
                <div class="char-select-container">
                    <div class="game-title" style="margin-bottom:15px">
                        <div class="title-main" style="font-size:3rem">SELECT FIGHTER</div>
                    </div>

                    <div class="selecting-indicator" id="selecting-indicator">PLAYER 1 - CHOOSE YOUR FIGHTER</div>

                    <!-- AI Difficulty (hidden for local) -->
                    <div class="difficulty-selector" id="difficulty-selector" style="display:none">
                        <button class="diff-btn active" data-diff="easy" onclick="setDifficulty('easy')">EASY</button>
                        <button class="diff-btn medium" data-diff="medium"
                            onclick="setDifficulty('medium')">MEDIUM</button>
                        <button class="diff-btn hard" data-diff="hard" onclick="setDifficulty('hard')">HARD</button>
                    </div>

                    <div class="player-info-row">
                        <div class="player-banner p1">P1: <span id="p1-name">SPICY</span></div>
                        <div class="player-banner p2">P2: <span id="p2-name">SALTY</span></div>
                    </div>

                    <div class="char-grid">
                        <div class="char-card" data-char="Spicy" onclick="selectCharacter('Spicy')">
                            <div class="char-icon" style="background:#FF4D4D"></div>
                            <h3>SPICY</h3>
                            <p class="role">Glass Cannon</p>
                            <p class="ability">üî• Fireball</p>
                            <div class="stats">
                                <div class="stat-row"><span>PWR</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:90%;background:#FF4D4D"></div>
                                    </div>
                                </div>
                                <div class="stat-row"><span>HP</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:40%;background:#FF4D4D"></div>
                                    </div>
                                </div>
                                <div class="stat-row"><span>SPD</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:70%;background:#FF4D4D"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="char-card" data-char="Salty" onclick="selectCharacter('Salty')">
                            <div class="char-icon" style="background:#FFFFFF"></div>
                            <h3>SALTY</h3>
                            <p class="role">Tank</p>
                            <p class="ability">üõ°Ô∏è Salt Shield</p>
                            <div class="stats">
                                <div class="stat-row"><span>PWR</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:50%;background:#ccc"></div>
                                    </div>
                                </div>
                                <div class="stat-row"><span>HP</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:100%;background:#ccc"></div>
                                    </div>
                                </div>
                                <div class="stat-row"><span>SPD</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:40%;background:#ccc"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="char-card" data-char="Sour" onclick="selectCharacter('Sour')">
                            <div class="char-icon" style="background:#CCFF00"></div>
                            <h3>SOUR</h3>
                            <p class="role">Disruptor</p>
                            <p class="ability">üíß Acid Pool</p>
                            <div class="stats">
                                <div class="stat-row"><span>PWR</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:60%;background:#CCFF00"></div>
                                    </div>
                                </div>
                                <div class="stat-row"><span>HP</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:65%;background:#CCFF00"></div>
                                    </div>
                                </div>
                                <div class="stat-row"><span>SPD</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:60%;background:#CCFF00"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="char-card" data-char="Sweet" onclick="selectCharacter('Sweet')">
                            <div class="char-icon" style="background:#FF69B4"></div>
                            <h3>SWEET</h3>
                            <p class="role">Speedster</p>
                            <p class="ability">üí® Sugar Rush</p>
                            <div class="stats">
                                <div class="stat-row"><span>PWR</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:45%;background:#FF69B4"></div>
                                    </div>
                                </div>
                                <div class="stat-row"><span>HP</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:55%;background:#FF69B4"></div>
                                    </div>
                                </div>
                                <div class="stat-row"><span>SPD</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:100%;background:#FF69B4"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="char-card" data-char="Umami" onclick="selectCharacter('Umami')">
                            <div class="char-icon" style="background:#9D00FF"></div>
                            <h3>UMAMI</h3>
                            <p class="role">Brawler</p>
                            <p class="ability">üî® Meat Hammer</p>
                            <div class="stats">
                                <div class="stat-row"><span>PWR</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:80%;background:#9D00FF"></div>
                                    </div>
                                </div>
                                <div class="stat-row"><span>HP</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:75%;background:#9D00FF"></div>
                                    </div>
                                </div>
                                <div class="stat-row"><span>SPD</span>
                                    <div class="stat-bar-bg">
                                        <div class="bar" style="width:40%;background:#9D00FF"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="button-row">
                        <button class="btn-cartoon gray btn-small" onclick="showScreen('mode-select')">‚Üê BACK</button>
                        <button class="btn-cartoon green" onclick="startFight()">
                            <span class="btn-icon">‚öîÔ∏è</span> FIGHT!
                        </button>
                    </div>
                </div>
            </section>

            <!-- SETTINGS -->
            <section id="settings" class="screen">
                <div class="panel-container" style="max-width:600px">
                    <h2>‚öôÔ∏è OPTIONS</h2>

                    <div class="setting-group">
                        <label>MUSIC VOLUME</label>
                        <input type="range" min="0" max="100" value="30" id="musicVolume">
                    </div>
                    <div class="setting-group">
                        <label>SFX VOLUME</label>
                        <input type="range" min="0" max="100" value="50" id="sfxVolume">
                    </div>

                    <h3 style="color:#ffcc00;margin:20px 0 15px">üéÆ CONTROLS</h3>
                    <div class="controls-grid">
                        <div class="control-section">
                            <h4>PLAYER 1</h4>
                            <div class="control-row">
                                <span>Move Left</span>
                                <input type="text" id="ctrl-p1-left" value="a" maxlength="1"
                                    onclick="bindKey(this, 'p1', 'left')">
                            </div>
                            <div class="control-row">
                                <span>Move Right</span>
                                <input type="text" id="ctrl-p1-right" value="d" maxlength="1"
                                    onclick="bindKey(this, 'p1', 'right')">
                            </div>
                            <div class="control-row">
                                <span>Jump</span>
                                <input type="text" id="ctrl-p1-jump" value="w" maxlength="1"
                                    onclick="bindKey(this, 'p1', 'jump')">
                            </div>
                            <div class="control-row">
                                <span>Attack</span>
                                <span class="key-display">SPACE</span>
                            </div>
                            <div class="control-row">
                                <span>Special</span>
                                <input type="text" id="ctrl-p1-special" value="f" maxlength="1"
                                    onclick="bindKey(this, 'p1', 'special')">
                            </div>
                        </div>
                        <div class="control-section">
                            <h4>PLAYER 2</h4>
                            <div class="control-row">
                                <span>Move Left</span>
                                <span class="key-display">‚Üê</span>
                            </div>
                            <div class="control-row">
                                <span>Move Right</span>
                                <span class="key-display">‚Üí</span>
                            </div>
                            <div class="control-row">
                                <span>Jump</span>
                                <span class="key-display">‚Üë</span>
                            </div>
                            <div class="control-row">
                                <span>Attack</span>
                                <span class="key-display">.</span>
                            </div>
                            <div class="control-row">
                                <span>Special</span>
                                <span class="key-display">/</span>
                            </div>
                        </div>
                    </div>

                    <div class="button-row" style="margin-top:20px">
                        <button class="btn-cartoon yellow btn-small" onclick="resetControls(); loadControlSettings()">üîÑ
                            RESET</button>
                        <button class="btn-cartoon gray btn-small" onclick="showScreen('main-menu')">‚Üê BACK</button>
                    </div>
                </div>
            </section>

            <!-- LEADERBOARD -->
            <section id="leaderboard" class="screen">
                <div class="panel-container" style="min-width:500px">
                    <h2>üèÜ LEADERBOARD</h2>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>RANK</th>
                                <th>CHEF</th>
                                <th>WINS</th>
                                <th>DMG</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr>
                                <td colspan="4" style="text-align:center;color:#888">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn-cartoon gray btn-small" onclick="showScreen('main-menu')">‚Üê BACK</button>
                </div>
            </section>

            <!-- GAME OVER -->
            <section id="game-over" class="screen">
                <div class="game-over-container">
                    <div class="winner-crown">üëë</div>
                    <h1 id="winner-text">SPICY WINS!</h1>
                    <div class="game-stats">
                        <div class="stat-item">
                            <div class="stat-label">ROUND TIME</div>
                            <div class="stat-value" id="round-time">45s</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">TOTAL DAMAGE</div>
                            <div class="stat-value" id="total-damage">150</div>
                        </div>
                    </div>
                    <div class="button-row">
                        <button class="btn-cartoon green" onclick="doRematch()">‚öîÔ∏è REMATCH</button>
                        <button class="btn-cartoon blue" onclick="backToMenu()">üè† MENU</button>
                    </div>
                </div>
            </section>

        </div>

        <!-- GAME HUD -->
        <div id="game-ui" class="game-ui hidden">
            <div class="hud-top">
                <div class="player-hud p1">
                    <div class="portrait" id="p1Portrait" style="background:#FF4D4D"></div>
                    <div class="bars">
                        <div class="name" id="p1HudName">SPICY</div>
                        <div class="health-container">
                            <div class="health-bar-fill" id="player1Health" style="width:100%"></div>
                        </div>
                    </div>
                </div>
                <div class="timer-container">
                    <div id="timer" class="timer-display">60</div>
                    <div class="timer-label">SEC</div>
                </div>
                <div class="player-hud p2">
                    <div class="bars">
                        <div class="name" id="p2HudName">SALTY</div>
                        <div class="health-container">
                            <div class="health-bar-fill" id="player2Health" style="width:100%"></div>
                        </div>
                    </div>
                    <div class="portrait" id="p2Portrait" style="background:#FFFFFF"></div>
                </div>
            </div>
            <div id="displayText" class="message-display"></div>
        </div>

        <!-- PAUSE MENU -->
        <div id="pause-menu" class="pause-overlay" style="display:none">
            <div class="pause-panel">
                <h2>‚è∏Ô∏è PAUSED</h2>
                <button class="btn-cartoon green" onclick="resumeGame()">‚ñ∂Ô∏è RESUME</button>
                <button class="btn-cartoon yellow" onclick="restartGame()">üîÑ RESTART</button>
                <button class="btn-cartoon gray" onclick="exitToMenu()">üö™ EXIT TO MENU</button>
                <p style="margin-top:20px;color:#999;font-size:14px">Press ESC to resume</p>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- Supabase (optional - add your keys) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>

    <!-- Game Engine -->
    <script src="game.js"></script>

    <!-- UI Logic -->
    <script>
        // Game state
        let p1Selection = 'Spicy';
        let p2Selection = 'Salty';
        let selectingPlayer = 1;
        let gameMode = 'local';
        let aiDifficulty = 'easy';

        const charColors = {
            'Spicy': '#FF4D4D',
            'Salty': '#FFFFFF',
            'Sour': '#CCFF00',
            'Sweet': '#FF69B4',
            'Umami': '#9D00FF'
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById(id);
            if (screen) screen.classList.add('active');

            // Auto-fetch leaderboard when showing that screen
            if (id === 'leaderboard' && window.updateLeaderboardUI) {
                window.updateLeaderboardUI();
            }
        }

        function showLockedMessage() {
            alert('üîí Multiplayer coming soon! Complete Supabase setup to unlock.');
        }

        function startCharSelect(mode) {
            gameMode = mode;
            selectingPlayer = 1;
            updateSelectingIndicator();

            // Show difficulty selector for AI mode
            const diffSelector = document.getElementById('difficulty-selector');
            diffSelector.style.display = mode === 'ai' ? 'flex' : 'none';

            showScreen('char-select');
        }

        function setDifficulty(diff) {
            aiDifficulty = diff;
            document.querySelectorAll('.diff-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.diff === diff) btn.classList.add('active');
            });
        }

        function updateSelectingIndicator() {
            const el = document.getElementById('selecting-indicator');
            if (gameMode === 'ai' && selectingPlayer === 2) {
                el.textContent = 'AI OPPONENT SELECTED';
                el.style.color = '#ff6666';
            } else {
                el.textContent = `PLAYER ${selectingPlayer} - CHOOSE YOUR FIGHTER`;
                el.style.color = selectingPlayer === 1 ? '#FF4D4D' : '#00CCFF';
            }
        }

        function selectCharacter(char) {
            document.querySelectorAll('.char-card').forEach(c => {
                c.classList.remove('selected-p1', 'selected-p2');
            });

            if (selectingPlayer === 1) {
                p1Selection = char;
                document.getElementById('p1-name').textContent = char.toUpperCase();
                document.querySelector(`[data-char="${char}"]`).classList.add('selected-p1');

                if (gameMode === 'ai') {
                    // AI picks random character
                    const chars = ['Spicy', 'Salty', 'Sour', 'Sweet', 'Umami'];
                    p2Selection = chars[Math.floor(Math.random() * chars.length)];
                    document.getElementById('p2-name').textContent = 'AI: ' + p2Selection.toUpperCase();
                    document.querySelector(`[data-char="${p2Selection}"]`).classList.add('selected-p2');
                } else {
                    selectingPlayer = 2;
                    updateSelectingIndicator();
                }
            } else {
                p2Selection = char;
                document.getElementById('p2-name').textContent = char.toUpperCase();
                selectingPlayer = 1;
                updateSelectingIndicator();
            }

            // Re-apply selections
            document.querySelector(`[data-char="${p1Selection}"]`)?.classList.add('selected-p1');
            document.querySelector(`[data-char="${p2Selection}"]`)?.classList.add('selected-p2');
        }

        function startFight() {
            document.getElementById('p1Portrait').style.background = charColors[p1Selection];
            document.getElementById('p2Portrait').style.background = charColors[p2Selection];
            document.getElementById('p1HudName').textContent = p1Selection.toUpperCase();
            document.getElementById('p2HudName').textContent = gameMode === 'ai' ? 'AI: ' + p2Selection.toUpperCase() : p2Selection.toUpperCase();

            window.p1Selection = p1Selection;
            window.p2Selection = p2Selection;
            window.gameMode = gameMode;
            window.aiDifficulty = aiDifficulty;

            document.getElementById('screens').style.display = 'none';
            document.getElementById('game-ui').classList.remove('hidden');

            if (window.initGame) window.initGame();
        }

        function backToMenu() {
            document.getElementById('screens').style.display = 'block';
            document.getElementById('game-ui').classList.add('hidden');
            showScreen('main-menu');
        }

        function doRematch() {
            document.getElementById('displayText').style.display = 'none';
            document.getElementById('screens').style.display = 'none';
            document.getElementById('game-ui').classList.remove('hidden');
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if (window.resetGame) window.resetGame();
        }

        // Auth handlers - requires valid credentials
        function handleLogin() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value;

            if (!user || !pass) {
                alert('‚ùå Please enter both username and password!');
                return;
            }
            if (pass.length < 6) {
                alert('‚ùå Password must be at least 6 characters!');
                return;
            }

            if (window.supabaseLogin) {
                window.supabaseLogin(user, pass);
            } else {
                alert('‚ùå Supabase not loaded. Check your internet connection.');
            }
        }

        function handleSignup() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value;

            if (!user || !pass) {
                alert('‚ùå Please enter both username and password!');
                return;
            }
            if (user.length < 3) {
                alert('‚ùå Username must be at least 3 characters!');
                return;
            }
            if (pass.length < 6) {
                alert('‚ùå Password must be at least 6 characters!');
                return;
            }

            if (window.supabaseSignup) {
                window.supabaseSignup(user, pass);
            } else {
                alert('‚ùå Supabase not loaded. Check your internet connection.');
            }
        }

        // ========== CONTROL SETTINGS ==========
        function bindKey(input, player, action) {
            input.value = '';
            input.placeholder = 'Press...';

            const handler = (e) => {
                e.preventDefault();
                const key = e.key === ' ' ? ' ' : e.key.length === 1 ? e.key.toLowerCase() : e.key;
                input.value = key === ' ' ? 'SPACE' : key.toUpperCase();

                if (window.gameControls) {
                    window.gameControls[player][action] = key;
                    if (window.saveGameControls) window.saveGameControls();
                }

                input.removeEventListener('keydown', handler);
                input.blur();
            };

            input.addEventListener('keydown', handler);
        }

        function loadControlSettings() {
            if (window.gameControls) {
                const c = window.gameControls;
                const el = (id) => document.getElementById(id);
                if (el('ctrl-p1-left')) el('ctrl-p1-left').value = c.p1.left.toUpperCase();
                if (el('ctrl-p1-right')) el('ctrl-p1-right').value = c.p1.right.toUpperCase();
                if (el('ctrl-p1-jump')) el('ctrl-p1-jump').value = c.p1.jump.toUpperCase();
                if (el('ctrl-p1-special')) el('ctrl-p1-special').value = c.p1.special.toUpperCase();
            }
        }

        // Guest Login
        function handleGuest() {
            window.currentUser = { id: 'guest', email: 'guest@player', user_metadata: { display_name: 'Guest' } };
            alert('‚úÖ Logging in as Guest...');
            showScreen('main-menu');
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            selectCharacter('Spicy');
            selectingPlayer = 2;
            selectCharacter('Salty');
            selectingPlayer = 1;
            updateSelectingIndicator();

            // Load control settings
            setTimeout(loadControlSettings, 100);
        });
    </script>
</body>

</html>